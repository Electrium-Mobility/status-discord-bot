# 🧪 Outline 同步功能测试指南

## 概述

在正式运行 Outline 同步功能之前，我们提供了多种安全的测试方式，确保不会对生产环境造成影响。

## 🛡️ 安全测试策略

### 1. 综合功能测试（推荐第一步）

一次性完成配置验证和模拟运行，快速了解系统状态。

**命令**: `/test-outline-features`

**功能**:

- ✅ 检查所有映射的 Discord 角色是否存在
- 📊 显示配置统计信息
- 🧪 显示当前测试设置
- ❌ 列出无效的角色映射
- 🔍 模拟所有同步操作
- 📝 显示将要执行的操作

**安全性**: 100% 安全，不会对 Outline 造成任何影响

**示例输出**:

```
🧪 Outline功能测试报告
✅ 配置验证 - 所有配置项验证通过
🔍 模拟运行 - 已完成同步操作模拟

📊 验证统计
✅ 有效映射: 8
❌ 无效映射: 1
📋 总映射数: 9

🧪 测试设置
测试模式: 关闭
模拟运行: 关闭
测试前缀: TEST-
最大测试成员: 5
```

### 2. 生产环境同步

确认测试无误后的正式同步。

**命令**: `/sync-outline` 或 `/sync-outline dry_run:True`

**功能**:

- 🔄 完整同步所有映射的角色（正常模式）
- 🔍 模拟运行（dry_run 模式）
- 🆕 创建正式的 Outline 群组
- 👥 同步所有角色成员

## 📋 推荐测试流程

### 第一阶段：综合测试

```bash
1. 运行 /test-outline-features
2. 检查配置验证结果
3. 查看模拟运行报告
4. 如有问题，修改 role_mapping.json
5. 运行 /reload-mappings
6. 重复步骤1直到所有测试通过
```

### 第二阶段：生产同步

```bash
1. 确认第一阶段测试成功
2. 可选：运行 /sync-outline dry_run:True 再次确认
3. 运行 /sync-outline 执行正式同步
4. 监控同步过程和结果
```

## ⚙️ 测试配置说明

### role_mapping.json 测试设置

```json
{
  "test_settings": {
    "test_mode": false, // 是否启用测试模式
    "dry_run": false, // 是否默认进行模拟运行
    "test_group_prefix": "TEST-", // 测试群组前缀
    "max_test_members": 5 // 测试模式最大成员数
  }
}
```

## 🚨 故障排除

### 常见问题

#### 1. 配置验证失败

**问题**: 显示无效映射
**解决**:

- 检查 Discord 服务器中是否存在对应角色
- 确认角色名称拼写正确（区分大小写）
- 更新 role_mapping.json 文件

#### 2. 模拟运行报错

**问题**: 模拟运行时出现错误
**解决**:

- 检查 Outline API token 是否有效
- 确认网络连接正常
- 查看错误详情进行针对性修复

#### 3. 成员同步不完整

**问题**: 部分成员未同步到 Outline
**解决**:

- 检查成员邮箱格式（默认：username@electrium.com）
- 确认成员在 Outline 中已存在
- 调整用户匹配逻辑

## 📊 测试检查清单

### 运行前检查

- [ ] 已备份重要的 Outline 群组设置
- [ ] 确认有足够的 API 调用限额
- [ ] 验证所有必需的环境变量已设置
- [ ] 检查 role_mapping.json 语法正确

### 综合测试检查

- [ ] 所有 Discord 角色都存在
- [ ] 群组名称符合命名规范
- [ ] 同步报告显示正常
- [ ] 没有意外的错误信息
- [ ] 要同步的角色和成员数量合理

### 生产同步检查

- [ ] 所有群组创建成功
- [ ] 成员同步完整
- [ ] 没有权限或 API 错误

## 🔧 高级测试技巧

### 1. 分批测试

如果角色很多，可以临时修改配置文件，只测试部分角色：

```json
{
  "f25_projects": {
    "mappings": {
      "Bike-F25": "F25-Bike-Team" // 只保留一个进行测试
    }
  }
}
```

### 2. 日志监控

运行测试时关注控制台日志，查看详细的执行过程。

### 3. API 限制测试

如果担心 API 调用过多，可以先用少量角色测试 API 响应速度。

## 📝 测试记录模板

```
测试日期: ____
测试人员: ____
测试环境: [开发/测试/生产]

综合测试结果:
- 配置验证: [通过/失败]
- 模拟运行: [成功/失败]
- 发现问题: ____________

生产同步结果:
- 执行状态: [成功/失败]
- 最终状态: ____________

备注: ________________
```

## 🎯 测试成功标准

### 综合测试成功

- ✅ 所有映射角色都存在
- ✅ 没有配置语法错误
- ✅ 模拟运行无错误
- ✅ 同步逻辑正确
- ✅ 报告信息完整

### 生产同步成功

- ✅ 所有群组创建成功
- ✅ 成员同步完整
- ✅ 没有数据丢失或错误

## 📋 可用命令总览

| 命令                         | 描述                            | 安全性       |
| ---------------------------- | ------------------------------- | ------------ |
| `/test-outline-features`     | 综合测试（配置验证+模拟运行）   | 100%安全     |
| `/sync-outline`              | 正式同步 Discord 角色到 Outline | 执行实际操作 |
| `/sync-outline dry_run:True` | 模拟同步（不执行实际操作）      | 100%安全     |
| `/show-role-mappings`        | 显示当前角色映射配置            | 100%安全     |
| `/reload-mappings`           | 重新加载配置文件                | 安全         |

遵循这个测试指南，你可以安全地验证和部署 Outline 同步功能，避免对生产环境造成不可逆的影响。

## ⚙️ 测试配置说明

### role_mapping.json 测试设置

```json
{
  "test_settings": {
    "test_mode": false, // 是否启用测试模式
    "dry_run": false, // 是否默认进行模拟运行
    "test_group_prefix": "TEST-", // 测试群组前缀
    "max_test_members": 5 // 测试模式最大成员数
  }
}
```

### 测试模式特性

- **群组前缀**: 所有群组名称前添加"TEST-"
- **成员限制**: 每个角色最多同步 5 个成员
- **临时启用**: 测试完成后自动恢复原设置

## 🚨 故障排除

### 常见问题

#### 1. 配置验证失败

**问题**: 显示无效映射
**解决**:

- 检查 Discord 服务器中是否存在对应角色
- 确认角色名称拼写正确（区分大小写）
- 更新 role_mapping.json 文件

#### 2. 模拟运行报错

**问题**: 模拟运行时出现错误
**解决**:

- 检查 Outline API token 是否有效
- 确认网络连接正常
- 查看错误详情进行针对性修复

#### 3. 测试同步失败

**问题**: 测试模式下创建群组失败
**解决**:

- 确认 Outline API 权限足够
- 检查群组名称是否符合 Outline 规范
- 验证用户邮箱匹配规则

#### 4. 成员同步不完整

**问题**: 部分成员未同步到 Outline
**解决**:

- 检查成员邮箱格式（默认：username@electrium.com）
- 确认成员在 Outline 中已存在
- 调整用户匹配逻辑

## 📊 测试检查清单

### 运行前检查

- [ ] 已备份重要的 Outline 群组设置
- [ ] 确认有足够的 API 调用限额
- [ ] 验证所有必需的环境变量已设置
- [ ] 检查 role_mapping.json 语法正确

### 配置验证检查

- [ ] 所有 Discord 角色都存在
- [ ] 群组名称符合命名规范
- [ ] 测试设置配置合理

### 模拟运行检查

- [ ] 同步报告显示正常
- [ ] 没有意外的错误信息
- [ ] 要同步的角色和成员数量合理

### 测试模式检查

- [ ] TEST-前缀群组创建成功
- [ ] 成员数量限制生效
- [ ] 可以手动清理测试群组

### 生产同步检查

- [ ] 所有群组创建成功
- [ ] 成员同步完整
- [ ] 没有权限或 API 错误

## 🔧 高级测试技巧

### 1. 分批测试

如果角色很多，可以临时修改配置文件，只测试部分角色：

```json
{
  "f25_projects": {
    "mappings": {
      "Bike-F25": "F25-Bike-Team" // 只保留一个进行测试
    }
  }
}
```

### 2. 日志监控

运行测试时关注控制台日志，查看详细的执行过程。

### 3. API 限制测试

如果担心 API 调用过多，可以先用少量角色测试 API 响应速度。

## 📝 测试记录模板

```
测试日期: ____
测试人员: ____
测试环境: [开发/测试/生产]

配置验证结果:
- 有效映射: __ / __
- 发现问题: ____________

模拟运行结果:
- 执行状态: [成功/失败]
- 发现问题: ____________

测试模式结果:
- 创建群组: __ / __
- 同步成员: __ / __
- 发现问题: ____________

生产同步结果:
- 执行状态: [成功/失败]
- 最终状态: ____________

备注: ________________
```

## 🎯 测试成功标准

### 配置验证成功

- ✅ 所有映射角色都存在
- ✅ 没有配置语法错误
- ✅ 测试设置合理

### 模拟运行成功

- ✅ 没有 API 连接错误
- ✅ 同步逻辑正确
- ✅ 报告信息完整

### 测试模式成功

- ✅ 测试群组创建成功
- ✅ 成员同步正确
- ✅ 可以清理测试数据

### 生产同步成功

- ✅ 所有群组创建成功
- ✅ 成员同步完整
- ✅ 没有数据丢失或错误

遵循这个测试指南，你可以安全地验证和部署 Outline 同步功能，避免对生产环境造成不可逆的影响。
